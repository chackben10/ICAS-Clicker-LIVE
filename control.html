<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ICAS Media Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root {
      --bg: #ffffff;
      --title-color: #d32f2f;
      --status-grey: #666666;

      --card-bg: #f3f3f3;
      --card-text: #111111;
      --border-color: #d0d0d0;

      --btn-bg: #ffffff;
      --btn-text: #111111;
      --btn-border: #d0d0d0;
      --btn-hover: rgba(128,128,128,0.12);

      --modal-bg: #ffffff;
      --modal-shadow: rgba(0,0,0,0.25);
      --settings-text: #111;

      --danger: #ff5252;
      --ok: #00c853;
    }

    body.dark {
      --bg: #000000;
      --title-color: #ff5252;
      --status-grey: #888888;

      --card-bg: #121212;
      --card-text: #ffffff;
      --border-color: #444444;

      --btn-bg: #111111;
      --btn-text: #ffffff;
      --btn-border: #444444;
      --btn-hover: rgba(255,255,255,0.08);

      --modal-bg: #111111;
      --modal-shadow: rgba(0,0,0,0.6);
      --settings-text: #ffffff;

      --danger: #ff5252;
      --ok: #00c853;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; }

    body {
      background: var(--bg);
      color: var(--card-text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 12px;

      transition: background 0.25s ease, color 0.25s ease;
      touch-action: manipulation;
      -webkit-overflow-scrolling: touch;
    }

    .wrapper { width: 100%; max-width: 680px; padding: 16px; }

    /* Top bar */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 12px;
    }

    .page-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--status-grey);
    }

    .top-btn {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--btn-text);
      opacity: 0.9;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .top-btn:hover { opacity: 1; background: var(--btn-hover); }

    .panel-title {
      color: var(--title-color);
      font-size: 1.45rem;
      font-weight: 800;
      margin: 6px 0 8px;
      line-height: 1.1;
    }

    .desc {
      color: var(--status-grey);
      font-size: 0.98rem;
      line-height: 1.35;
      margin-bottom: 12px;
    }

    .pill-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--status-grey);
      font-size: 0.92rem;
      background: transparent;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok { background: var(--ok); }

    .status-text {
      font-variant-numeric: tabular-nums;
      font-weight: 800;
      color: var(--card-text);
    }

    .note {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      padding: 12px;
      color: var(--status-grey);
      font-size: 0.92rem;
      line-height: 1.35;
    }

    .note b { color: var(--card-text); }

    /* Preset buttons */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .preset-btn {
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 14px 14px;
      cursor: pointer;
      transition: transform 0.07s ease, filter 0.07s ease, background 0.15s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .preset-btn:hover { background: var(--btn-hover); }
    .preset-btn:active { transform: scale(0.99); filter: brightness(0.98); }
    .preset-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .preset-title {
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }

    .preset-sub {
      color: var(--status-grey);
      font-size: 0.95rem;
      line-height: 1.25;
    }

    .below {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      background: transparent;
      padding: 12px;
    }

    .below-title {
      font-weight: 900;
      margin-bottom: 6px;
      color: var(--card-text);
    }

    .select-wrap { position: relative; width: 100%; margin-top: 8px; }
    .select-wrap::after {
      content: "▾";
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--card-text);
      opacity: 0.8;
      pointer-events: none;
      font-weight: 900;
    }

    .select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--card-text);
      padding: 12px 40px 12px 12px;
      font-size: 16px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      font-weight: 800;
    }

    .mini-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .mini-btn {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--card-text);
      font-weight: 800;
      font-size: 0.92rem;
      padding: 10px 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .mini-btn:hover { background: var(--btn-hover); }
    .mini-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    /* Settings modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 18px;
    }

    .settings-card {
      width: 100%;
      max-width: 380px;
      background: var(--modal-bg);
      color: var(--settings-text);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 18px 40px var(--modal-shadow);
      border: 1px solid var(--border-color);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .settings-title {
      font-size: 1.1rem;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .settings-row-column {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-top: 6px;
      gap: 6px;
    }

    .segment {
      display: flex;
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 4px;
    }

    .segment button {
      flex: 1;
      padding: 8px 0;
      background: transparent;
      border: none;
      color: var(--settings-text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s;
      -webkit-tap-highlight-color: transparent;
      font-weight: 800;
    }

    .segment button:hover { background: rgba(128,128,128,0.12); }
    .segment button.active {
      background: #ff5252;
      color: white;
      font-weight: 900;
    }

    .settings-close-btn {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--settings-text);
      font-size: 0.95rem;
      padding: 10px 0;
      margin-top: 14px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-weight: 800;
    }
    .settings-close-btn:hover { background: rgba(128,128,128,0.12); }

    @media (min-width: 700px) {
      .grid { grid-template-columns: 1fr 1fr; }
      .service-span { grid-column: 1 / -1; }
      .show-span { grid-column: 1 / -1; }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="top-row">
      <div class="page-title">ICAS Media Control Panel</div>
      <button class="top-btn" id="settingsButton">Settings</button>
    </div>

    <div class="panel-title">Presets</div>
    <div class="desc">
      These buttons are presets that trigger multiple actions at once (ProPresenter + OBS).
      You can still control ProPresenter and OBS manually on their own screens anytime.
    </div>

    <div class="pill-row" aria-live="polite">
      <span class="pill" title="Cloudflare Tunnel backend status">
        <span id="backendDot" class="status-dot"></span>
        <span class="status-text" id="backendStatus">Backend: Checking…</span>
      </span>
      <span class="pill" title="Most recent action run from this page">
        <span class="status-text" id="lastAction">Last action: —</span>
      </span>
    </div>

    <div class="note" id="apiNote">
      API Base: <b id="apiBaseText">—</b><br/>
      If this is wrong, the page will not work from phones/iPads.
    </div>

    <div class="grid">
      <button class="preset-btn" id="btnStreamBeginning" type="button">
        <div class="preset-title">Stream Beginning</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>Starting Announcements</b> and sets OBS scene to <b>Stream Start</b>.
        </div>
      </button>

      <button class="preset-btn" id="btnCamera" type="button">
        <div class="preset-title">Camera</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>PTZ Camera</b> and sets OBS scene to <b>PTZ Camera</b>.
        </div>
      </button>

      <div class="service-span">
        <button class="preset-btn" id="btnServiceLogo" type="button" style="width:100%;">
          <div class="preset-title">Service Logo</div>
          <div class="preset-sub" id="serviceLogoDesc">
            Sets ProPresenter Announcement to <b>Basic Service Logo</b>, and shows the <b>Audience Camera</b> on OBS.
          </div>
        </button>

        <div class="below">
          <div class="below-title">Default Service Logo</div>
          <div class="preset-sub">
            This selection is used for <b>Service Logo</b> and <b>Testimonies</b>.
          </div>

          <div class="select-wrap">
            <select id="serviceLogoSelect" class="select"></select>
          </div>

          <div class="mini-row">
            <button class="mini-btn" id="refreshLogosBtn" type="button">Refresh List</button>
            <button class="mini-btn" id="testBackendBtn" type="button">Test Backend</button>
          </div>
        </div>
      </div>

      <button class="preset-btn show-span" id="btnShowSlides" type="button">
        <div class="preset-title">Show Slides</div>
        <div class="preset-sub">
          Clears ProPresenter Announcements and sets OBS scene to <b>ProPresenter Input</b>.
        </div>
      </button>

      <button class="preset-btn" id="btnTestimonies" type="button">
        <div class="preset-title">Testimonies</div>
        <div class="preset-sub" id="testimoniesDesc">
          Sets ProPresenter Announcement to <b>Basic Service Logo</b> and sets OBS scene to <b>Testimonies</b>.
        </div>
      </button>

      <button class="preset-btn" id="btnEndingStream" type="button">
        <div class="preset-title">Ending Stream</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>Ending Announcements</b> and sets OBS scene to <b>Thanks Screen</b>.
        </div>
      </button>
    </div>
  </div>

  <!-- Settings modal (Theme only) -->
  <div id="settingsOverlay" class="settings-overlay">
    <div class="settings-card">
      <div class="settings-title">Settings</div>

      <div class="settings-row-column">
        <label style="font-weight:900;">Display Theme</label>
        <div class="segment" id="themeSegment" style="margin-top: 0;">
          <button data-mode="light">Light</button>
          <button data-mode="dark">Dark</button>
          <button data-mode="system">System</button>
        </div>
      </div>

      <button id="settingsCloseButton" class="settings-close-btn">Close</button>
    </div>
  </div>

  <script>
    (function () {
      // ====== CONFIG ======
      // This page is hosted at icas-clicker.work (GitHub Pages),
      // BUT the backend is the Cloudflare Tunnel host:
      //   https://control.icas-clicker.work
      const API_BASE_KEY = "icas-media-control-api-base";
      const DEFAULT_API_BASE = "https://control.icas-clicker.work";

      const THEME_KEY = "icas-theme-mode";
      const SERVICE_LOGO_UUID_KEY = "icas-service-logo-uuid";

      function normalizeBase(u) {
        u = String(u || "").trim();
        if (!u) return DEFAULT_API_BASE;
        return u.replace(/\/+$/, "");
      }

      function getApiBase() {
        const v = normalizeBase(localStorage.getItem(API_BASE_KEY));
        return v || DEFAULT_API_BASE;
      }

      function endpoints() {
        const base = getApiBase();
        return {
          health: `${base}/health`,
          serviceLogos: `${base}/service_logos`,
          preset: `${base}/preset`
        };
      }

      // ====== THEME ======
      function applyTheme(mode) {
        if (mode === "light") document.body.classList.remove("dark");
        else if (mode === "dark") document.body.classList.add("dark");
        else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) document.body.classList.add("dark");
          else document.body.classList.remove("dark");
        }
        updateThemeSegmentUI(mode);
      }

      function updateThemeSegmentUI(mode) {
        document.querySelectorAll("#themeSegment button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.mode === mode);
        });
      }

      function loadTheme() {
        const stored = localStorage.getItem(THEME_KEY);
        applyTheme(stored || "system");
      }

      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        const stored = localStorage.getItem(THEME_KEY) || "system";
        if (stored === "system") applyTheme("system");
      });

      // ====== UI ======
      const backendDot = document.getElementById("backendDot");
      const backendStatus = document.getElementById("backendStatus");
      const lastAction = document.getElementById("lastAction");

      const apiBaseText = document.getElementById("apiBaseText");

      const serviceLogoSelect = document.getElementById("serviceLogoSelect");
      const refreshLogosBtn = document.getElementById("refreshLogosBtn");
      const testBackendBtn = document.getElementById("testBackendBtn");

      const serviceLogoDesc = document.getElementById("serviceLogoDesc");
      const testimoniesDesc = document.getElementById("testimoniesDesc");

      function setBackendStatus(ok, text) {
        backendDot.classList.toggle("ok", !!ok);
        backendStatus.textContent = text || (ok ? "Backend: Connected" : "Backend: Offline");
      }

      function setLastAction(text) {
        lastAction.textContent = `Last action: ${text || "—"}`;
      }

      function setButtonsEnabled(enabled) {
        document.querySelectorAll(".preset-btn").forEach(b => b.disabled = !enabled);
        refreshLogosBtn.disabled = !enabled;
      }

      function getServiceLogoUuid() {
        return (localStorage.getItem(SERVICE_LOGO_UUID_KEY) || "").trim();
      }
      function setServiceLogoUuid(uuid) {
        localStorage.setItem(SERVICE_LOGO_UUID_KEY, (uuid || "").trim());
      }

      function selectedServiceLogoName() {
        const opt = serviceLogoSelect.options[serviceLogoSelect.selectedIndex];
        return opt ? (opt.textContent || "—") : "—";
      }

      function escapeHtml(s) {
        return String(s || "").replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function syncDescriptions() {
        const name = selectedServiceLogoName();
        serviceLogoDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(name)}</b>, and shows the <b>Audience Camera</b> on OBS.`;
        testimoniesDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(name)}</b> and sets OBS scene to <b>Testimonies</b>.`;
      }

      async function testBackend() {
        const { health } = endpoints();
        try {
          const res = await fetch(health, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          setBackendStatus(true, "Backend: Connected ✔");
          setButtonsEnabled(true);
          return true;
        } catch (e) {
          setBackendStatus(false, "Backend: Offline");
          setButtonsEnabled(false);
          return false;
        }
      }

      function fillServiceLogoSelect(items) {
        const prev = getServiceLogoUuid();
        serviceLogoSelect.innerHTML = "";

        if (!Array.isArray(items) || items.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No service logos found";
          serviceLogoSelect.appendChild(opt);
          serviceLogoSelect.value = "";
          syncDescriptions();
          return;
        }

        items.forEach(it => {
          const opt = document.createElement("option");
          opt.value = String(it.uuid || "");
          opt.textContent = String(it.name || "(Unnamed)");
          serviceLogoSelect.appendChild(opt);
        });

        if (prev && items.some(x => String(x.uuid) === prev)) {
          serviceLogoSelect.value = prev;
        } else {
          const basic = items.find(x => String(x.name) === "Basic Service Logo");
          if (basic) serviceLogoSelect.value = String(basic.uuid || "");
          else serviceLogoSelect.value = String(items[0].uuid || "");
          setServiceLogoUuid(serviceLogoSelect.value);
        }

        syncDescriptions();
      }

      async function refreshServiceLogos() {
        const { serviceLogos } = endpoints();
        try {
          const res = await fetch(serviceLogos, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          const data = await res.json();
          const items = Array.isArray(data?.items) ? data.items : [];
          fillServiceLogoSelect(items);
        } catch {
          fillServiceLogoSelect([]);
        }
      }

      serviceLogoSelect.addEventListener("change", () => {
        setServiceLogoUuid(serviceLogoSelect.value);
        syncDescriptions();
      });

      async function runPreset(presetName) {
        const ok = await testBackend();
        if (!ok) { setLastAction("Failed (backend offline)"); return; }

        const { preset } = endpoints();
        const payload = { preset: presetName };

        if (presetName === "service_logo" || presetName === "testimonies") {
          const uuid = getServiceLogoUuid();
          if (!uuid) { setLastAction("Failed (no Service Logo selected)"); return; }
          payload.service_logo_uuid = uuid;
        }

        setLastAction(`Running: ${presetName}`);

        try {
          const res = await fetch(preset, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Bad response");
          setLastAction(`Done: ${presetName}`);
        } catch {
          setLastAction(`Failed: ${presetName}`);
        }
      }

      // Wire buttons
      document.getElementById("btnStreamBeginning").onclick = () => runPreset("stream_beginning");
      document.getElementById("btnCamera").onclick = () => runPreset("camera");
      document.getElementById("btnServiceLogo").onclick = () => runPreset("service_logo");
      document.getElementById("btnShowSlides").onclick = () => runPreset("show_slides");
      document.getElementById("btnTestimonies").onclick = () => runPreset("testimonies");
      document.getElementById("btnEndingStream").onclick = () => runPreset("ending_stream");

      // Settings modal
      const settingsOverlay = document.getElementById("settingsOverlay");
      const settingsButton = document.getElementById("settingsButton");
      const settingsCloseButton = document.getElementById("settingsCloseButton");

      function openModal() { settingsOverlay.style.display = "flex"; }
      function closeModal() { settingsOverlay.style.display = "none"; }

      settingsButton.onclick = () => openModal();
      settingsCloseButton.onclick = () => closeModal();
      settingsOverlay.addEventListener("click", (e) => {
        if (e.target === settingsOverlay) closeModal();
      });

      document.querySelectorAll("#themeSegment button").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          localStorage.setItem(THEME_KEY, mode);
          applyTheme(mode);
        });
      });

      refreshLogosBtn.onclick = refreshServiceLogos;
      testBackendBtn.onclick = async () => {
        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
      };

      async function init() {
        loadTheme();
        updateThemeSegmentUI(localStorage.getItem(THEME_KEY) || "system");

        // Always show what base we are calling
        apiBaseText.textContent = getApiBase();

        setButtonsEnabled(false);
        setBackendStatus(false, "Backend: Checking…");
        setLastAction("—");

        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
        else fillServiceLogoSelect([]);

        // Light polling (optional): every 10s, not 1.5s
        setInterval(testBackend, 10000);
      }

      init();
    })();
  </script>
</body>
</html>
