<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ICAS Media Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root {
      --bg: #ffffff;
      --title-color: #d32f2f;
      --status-grey: #666666;

      --card-bg: #f3f3f3;
      --card-text: #111111;
      --border-color: #d0d0d0;

      --btn-bg: #ffffff;
      --btn-text: #111111;
      --btn-border: #d0d0d0;
      --btn-hover: rgba(128,128,128,0.12);

      --modal-bg: #ffffff;
      --modal-shadow: rgba(0,0,0,0.25);
      --settings-text: #111;

      --danger: #ff5252;
      --ok: #00c853;

      /* NEW: scale for preset button text only */
      --btn-text-scale: 100;
    }

    body.dark {
      --bg: #000000;
      --title-color: #ff5252;
      --status-grey: #888888;

      --card-bg: #121212;
      --card-text: #ffffff;
      --border-color: #444444;

      --btn-bg: #111111;
      --btn-text: #ffffff;
      --btn-border: #444444;
      --btn-hover: rgba(255,255,255,0.08);

      --modal-bg: #111111;
      --modal-shadow: rgba(0,0,0,0.6);
      --settings-text: #ffffff;

      --danger: #ff5252;
      --ok: #00c853;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; }

    body {
      background: var(--bg);
      color: var(--card-text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 12px;

      transition: background 0.25s ease, color 0.25s ease;
      touch-action: manipulation;
      -webkit-overflow-scrolling: touch;
    }

    .wrapper { width: 100%; max-width: 680px; padding: 16px; }

    /* Top bar */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 12px;
    }

    .page-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--status-grey);
    }

    .top-btn {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--btn-text);
      opacity: 0.9;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .top-btn:hover { opacity: 1; background: var(--btn-hover); }

    .panel-title {
      color: var(--title-color);
      font-size: 1.45rem;
      font-weight: 800;
      margin: 6px 0 8px;
      line-height: 1.1;
    }

    .desc {
      color: var(--status-grey);
      font-size: 0.98rem;
      line-height: 1.35;
      margin-bottom: 12px;
    }

    /* Preset buttons */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    .preset-btn {
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 14px 14px;
      cursor: pointer;
      transition: transform 0.07s ease, filter 0.07s ease, background 0.15s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
    }
    .preset-btn:hover { background: var(--btn-hover); }
    .preset-btn:active { transform: scale(0.99); filter: brightness(0.98); }
    .preset-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    /* NEW: only scale text INSIDE preset buttons */
    .preset-btn .preset-title {
      font-size: calc(1.15rem * (var(--btn-text-scale) / 100));
      font-weight: 900;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }
    .preset-btn .preset-sub {
      color: var(--status-grey);
      font-size: calc(0.95rem * (var(--btn-text-scale) / 100));
      line-height: 1.25;
    }

    /* Make selector scale with button text size too */
    .preset-btn .select {
      font-size: calc(16px * (var(--btn-text-scale) / 100));
    }

    .selector-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .select-wrap { position: relative; width: 100%; }
    .select-wrap::after {
      content: "▾";
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--card-text);
      opacity: 0.8;
      pointer-events: none;
      font-weight: 900;
    }

    .select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--card-text);
      padding: 12px 40px 12px 12px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      font-weight: 800;
    }

    /* Prevent button press when interacting with select */
    .select, .select-wrap, option { cursor: pointer; }
    .select { pointer-events: auto; }

    /* Settings modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 18px;
    }

    .settings-card {
      width: 100%;
      max-width: 420px;
      background: var(--modal-bg);
      color: var(--settings-text);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 18px 40px var(--modal-shadow);
      border: 1px solid var(--border-color);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .settings-title {
      font-size: 1.1rem;
      font-weight: 900;
      margin-bottom: 12px;
    }

    .settings-section {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      background: transparent;
    }

    .settings-label {
      font-weight: 900;
      margin-bottom: 6px;
    }

    .settings-muted {
      color: var(--status-grey);
      font-size: 0.92rem;
      line-height: 1.35;
    }

    .pill-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--status-grey);
      font-size: 0.92rem;
      background: transparent;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok { background: var(--ok); }

    .status-text {
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      color: var(--settings-text);
    }

    .mini-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .mini-btn {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--settings-text);
      font-weight: 900;
      font-size: 0.92rem;
      padding: 10px 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .mini-btn:hover { background: rgba(128,128,128,0.12); }
    .mini-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .segment {
      display: flex;
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    .segment button {
      flex: 1;
      padding: 8px 0;
      background: transparent;
      border: none;
      color: var(--settings-text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s;
      -webkit-tap-highlight-color: transparent;
      font-weight: 900;
    }

    .segment button:hover { background: rgba(128,128,128,0.12); }
    .segment button.active {
      background: #ff5252;
      color: white;
      font-weight: 900;
    }

    /* NEW: text size slider row (same vibe as picker) */
    .slider-row {
      display: flex;
      width: 100%;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .slider-row input[type="range"] { flex: 1; }
    .slider-value {
      color: var(--status-grey);
      width: 56px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
    }

    .settings-close-btn {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--settings-text);
      font-size: 0.95rem;
      padding: 10px 0;
      margin-top: 14px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-weight: 900;
    }
    .settings-close-btn:hover { background: rgba(128,128,128,0.12); }

    @media (min-width: 700px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="top-row">
      <div class="page-title">ICAS Media Control Panel</div>
      <button class="top-btn" id="settingsButton">Settings</button>
    </div>

    <div class="panel-title">Presets</div>
    <div class="desc">
      These buttons are presets that trigger multiple actions at once (ProPresenter + OBS).
      You can still control ProPresenter and OBS manually on their own screens anytime.
    </div>

    <div class="grid">
      <button class="preset-btn" id="btnStreamBeginning" type="button">
        <div class="preset-title">Stream Beginning</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>Starting Announcements</b> and sets OBS scene to <b>Stream Start</b>.
        </div>
      </button>

      <button class="preset-btn" id="btnCamera" type="button">
        <div class="preset-title">Camera</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>PTZ Camera</b> and sets OBS scene to <b>PTZ Camera</b>.
        </div>
      </button>

      <!-- Service Logo button includes its own selector -->
      <button class="preset-btn" id="btnServiceLogo" type="button">
        <div class="preset-title">Service Logo</div>
        <div class="preset-sub" id="serviceLogoDesc">
          Sets ProPresenter Announcement to <b>—</b>, and shows the <b>Audience Camera</b> on OBS.
        </div>

        <div class="selector-row" aria-label="Service Logo selector">
          <div class="select-wrap" style="flex: 1;">
            <select id="serviceLogoSelect" class="select" title="Default Service Logo"></select>
          </div>
        </div>
      </button>

      <button class="preset-btn" id="btnShowSlides" type="button">
        <div class="preset-title">Show Slides</div>
        <div class="preset-sub">
          Clears ProPresenter Announcements and sets OBS scene to <b>ProPresenter Input</b>.
        </div>
      </button>

      <!-- Testimonies button includes its own selector -->
      <button class="preset-btn" id="btnTestimonies" type="button">
        <div class="preset-title">Testimonies</div>
        <div class="preset-sub" id="testimoniesDesc">
          Sets ProPresenter Announcement to <b>—</b> and sets OBS scene to <b>Testimonies</b>.
        </div>

        <div class="selector-row" aria-label="Testimonies selector">
          <div class="select-wrap" style="flex: 1;">
            <select id="testimoniesLogoSelect" class="select" title="Testimonies Service Logo"></select>
          </div>
        </div>
      </button>

      <button class="preset-btn" id="btnEndingStream" type="button">
        <div class="preset-title">Ending Stream</div>
        <div class="preset-sub">
          Sets ProPresenter to <b>Ending Announcements</b> and sets OBS scene to <b>Thanks Screen</b>.
        </div>
      </button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsOverlay" class="settings-overlay">
    <div class="settings-card">
      <div class="settings-title">Settings</div>

      <div class="settings-section">
        <div class="settings-label">Backend Status</div>
        <div class="pill-row" aria-live="polite">
          <span class="pill" title="Cloudflare Tunnel backend status">
            <span id="backendDot" class="status-dot"></span>
            <span class="status-text" id="backendStatus">Backend: Checking…</span>
          </span>
          <span class="pill" title="Most recent action run from this page">
            <span class="status-text" id="lastAction">Last action: —</span>
          </span>
        </div>

        <div class="mini-row">
          <button class="mini-btn" id="refreshLogosBtn" type="button">Refresh List</button>
          <button class="mini-btn" id="testBackendBtn" type="button">Test Backend</button>
        </div>

        <div class="settings-muted" style="margin-top: 10px;">
          Backend should be: <b>https://control.icas-clicker.work</b>
        </div>
      </div>

      <!-- NEW: Text Size slider (controls ONLY preset button text) -->
      <div class="settings-section">
        <div class="settings-label">Button Text Size</div>
        <div class="slider-row">
          <input type="range" id="btnTextSizeSlider" min="50" max="300" step="10">
          <span id="btnTextSizeValue" class="slider-value">100%</span>
        </div>
        <div class="settings-muted" style="margin-top: 8px;">
          Changes text size inside preset buttons (titles, descriptions, and selectors) only.
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-label">Display Theme</div>
        <div class="segment" id="themeSegment">
          <button data-mode="light">Light</button>
          <button data-mode="dark">Dark</button>
          <button data-mode="system">System</button>
        </div>
      </div>

      <button id="settingsCloseButton" class="settings-close-btn">Close</button>
    </div>
  </div>

  <script>
    (function () {
      // ====== CONFIG ======
      const DEFAULT_API_BASE = "https://control.icas-clicker.work";

      const THEME_KEY = "icas-theme-mode";

      // Persisted selections
      const SERVICE_LOGO_UUID_KEY = "icas-service-logo-uuid";
      const TESTIMONIES_LOGO_UUID_KEY = "icas-testimonies-logo-uuid";

      // NEW: Button text size (same semantics as picker)
      const BTN_TEXT_SCALE_KEY = "icas-control-btn-text-scale"; // 50..300, default 100

      function normalizeBase(u) {
        u = String(u || "").trim();
        return (u || DEFAULT_API_BASE).replace(/\/+$/, "");
      }

      function getApiBase() {
        return normalizeBase(DEFAULT_API_BASE);
      }

      function endpoints() {
        const base = getApiBase();
        return {
          health: `${base}/health`,
          serviceLogos: `${base}/service_logos`,
          preset: `${base}/preset`
        };
      }

      // ====== THEME ======
      function applyTheme(mode) {
        if (mode === "light") document.body.classList.remove("dark");
        else if (mode === "dark") document.body.classList.add("dark");
        else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) document.body.classList.add("dark");
          else document.body.classList.remove("dark");
        }
        updateThemeSegmentUI(mode);
      }

      function updateThemeSegmentUI(mode) {
        document.querySelectorAll("#themeSegment button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.mode === mode);
        });
      }

      function loadTheme() {
        const stored = localStorage.getItem(THEME_KEY);
        applyTheme(stored || "system");
      }

      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        const stored = localStorage.getItem(THEME_KEY) || "system";
        if (stored === "system") applyTheme("system");
      });

      // ====== Button Text Size ======
      function getBtnTextScale() {
        const raw = parseInt(localStorage.getItem(BTN_TEXT_SCALE_KEY), 10);
        return Number.isNaN(raw) ? 100 : Math.min(300, Math.max(50, raw));
      }
      function setBtnTextScale(v) {
        localStorage.setItem(BTN_TEXT_SCALE_KEY, String(v));
      }
      function applyBtnTextScale(scale) {
        const s = Math.min(300, Math.max(50, parseInt(scale, 10) || 100));
        document.documentElement.style.setProperty("--btn-text-scale", String(s));
      }

      // ====== UI refs ======
      const backendDot = document.getElementById("backendDot");
      const backendStatus = document.getElementById("backendStatus");
      const lastAction = document.getElementById("lastAction");

      const refreshLogosBtn = document.getElementById("refreshLogosBtn");
      const testBackendBtn = document.getElementById("testBackendBtn");

      const serviceLogoSelect = document.getElementById("serviceLogoSelect");
      const testimoniesLogoSelect = document.getElementById("testimoniesLogoSelect");

      const serviceLogoDesc = document.getElementById("serviceLogoDesc");
      const testimoniesDesc = document.getElementById("testimoniesDesc");

      // NEW: slider refs
      const btnTextSizeSlider = document.getElementById("btnTextSizeSlider");
      const btnTextSizeValue = document.getElementById("btnTextSizeValue");

      // Prevent select taps from triggering the whole button
      function stopBtnClickWhenSelecting(selectEl) {
        ["click","pointerdown","touchstart","mousedown"].forEach(evt => {
          selectEl.addEventListener(evt, (e) => e.stopPropagation(), { passive: true });
        });
      }
      stopBtnClickWhenSelecting(serviceLogoSelect);
      stopBtnClickWhenSelecting(testimoniesLogoSelect);

      function setBackendStatus(ok, text) {
        backendDot.classList.toggle("ok", !!ok);
        backendStatus.textContent = text || (ok ? "Backend: Connected" : "Backend: Offline");
      }

      function setLastAction(text) {
        lastAction.textContent = `Last action: ${text || "—"}`;
      }

      function setButtonsEnabled(enabled) {
        document.querySelectorAll(".preset-btn").forEach(b => b.disabled = !enabled);
        refreshLogosBtn.disabled = !enabled;
        testBackendBtn.disabled = false; // always allow manual test attempt
        serviceLogoSelect.disabled = !enabled;
        testimoniesLogoSelect.disabled = !enabled;
      }

      function escapeHtml(s) {
        return String(s || "").replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function getStored(key) { return (localStorage.getItem(key) || "").trim(); }
      function setStored(key, val) { localStorage.setItem(key, String(val || "").trim()); }

      function selectedName(selectEl) {
        const opt = selectEl.options[selectEl.selectedIndex];
        return opt ? (opt.textContent || "—") : "—";
      }

      function syncDescriptions() {
        const sName = selectedName(serviceLogoSelect);
        const tName = selectedName(testimoniesLogoSelect);

        serviceLogoDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(sName)}</b>, and shows the <b>Audience Camera</b> on OBS.`;
        testimoniesDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(tName)}</b> and sets OBS scene to <b>Testimonies</b>.`;
      }

      async function testBackend() {
        const { health } = endpoints();
        try {
          const res = await fetch(health, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          setBackendStatus(true, "Backend: Connected ✔");
          setButtonsEnabled(true);
          return true;
        } catch {
          setBackendStatus(false, "Backend: Offline");
          setButtonsEnabled(false);
          return false;
        }
      }

      function fillSelect(selectEl, items, storageKey, preferBasic) {
        const prev = getStored(storageKey);
        selectEl.innerHTML = "";

        if (!Array.isArray(items) || items.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No service logos found";
          selectEl.appendChild(opt);
          selectEl.value = "";
          return;
        }

        items.forEach(it => {
          const opt = document.createElement("option");
          opt.value = String(it.uuid || "");
          opt.textContent = String(it.name || "(Unnamed)");
          selectEl.appendChild(opt);
        });

        if (prev && items.some(x => String(x.uuid) === prev)) {
          selectEl.value = prev;
        } else if (preferBasic) {
          const basic = items.find(x => String(x.name) === "Basic Service Logo");
          if (basic) selectEl.value = String(basic.uuid || "");
          else selectEl.value = String(items[0].uuid || "");
          setStored(storageKey, selectEl.value);
        } else {
          selectEl.value = String(items[0].uuid || "");
          setStored(storageKey, selectEl.value);
        }
      }

      async function refreshServiceLogos() {
        const { serviceLogos } = endpoints();
        try {
          const res = await fetch(serviceLogos, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          const data = await res.json();
          const items = Array.isArray(data?.items) ? data.items : [];

          fillSelect(serviceLogoSelect, items, SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, items, TESTIMONIES_LOGO_UUID_KEY, true);

          if (!getStored(SERVICE_LOGO_UUID_KEY)) setStored(SERVICE_LOGO_UUID_KEY, serviceLogoSelect.value);
          if (!getStored(TESTIMONIES_LOGO_UUID_KEY)) setStored(TESTIMONIES_LOGO_UUID_KEY, testimoniesLogoSelect.value);

          syncDescriptions();
        } catch {
          fillSelect(serviceLogoSelect, [], SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, [], TESTIMONIES_LOGO_UUID_KEY, true);
          syncDescriptions();
        }
      }

      serviceLogoSelect.addEventListener("change", () => {
        setStored(SERVICE_LOGO_UUID_KEY, serviceLogoSelect.value);
        syncDescriptions();
      });

      testimoniesLogoSelect.addEventListener("change", () => {
        setStored(TESTIMONIES_LOGO_UUID_KEY, testimoniesLogoSelect.value);
        syncDescriptions();
      });

      async function runPreset(presetName) {
        const ok = await testBackend();
        if (!ok) { setLastAction("Failed (backend offline)"); return; }

        const { preset } = endpoints();
        const payload = { preset: presetName };

        if (presetName === "service_logo") {
          const uuid = getStored(SERVICE_LOGO_UUID_KEY) || serviceLogoSelect.value;
          if (!uuid) { setLastAction("Failed (no Service Logo selected)"); return; }
          payload.service_logo_uuid = uuid;
        }

        if (presetName === "testimonies") {
          const uuid = getStored(TESTIMONIES_LOGO_UUID_KEY) || testimoniesLogoSelect.value;
          if (!uuid) { setLastAction("Failed (no Testimonies logo selected)"); return; }
          payload.service_logo_uuid = uuid; // backend expects service_logo_uuid
        }

        setLastAction(`Running: ${presetName}`);

        try {
          const res = await fetch(preset, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Bad response");
          setLastAction(`Done: ${presetName}`);
        } catch {
          setLastAction(`Failed: ${presetName}`);
        }
      }

      // Wire buttons (select inside won't trigger because we stopPropagation)
      document.getElementById("btnStreamBeginning").onclick = () => runPreset("stream_beginning");
      document.getElementById("btnCamera").onclick = () => runPreset("camera");
      document.getElementById("btnServiceLogo").onclick = () => runPreset("service_logo");
      document.getElementById("btnShowSlides").onclick = () => runPreset("show_slides");
      document.getElementById("btnTestimonies").onclick = () => runPreset("testimonies");
      document.getElementById("btnEndingStream").onclick = () => runPreset("ending_stream");

      // Settings modal
      const settingsOverlay = document.getElementById("settingsOverlay");
      const settingsButton = document.getElementById("settingsButton");
      const settingsCloseButton = document.getElementById("settingsCloseButton");

      function syncSettingsUI() {
        const scale = getBtnTextScale();
        btnTextSizeSlider.value = scale;
        btnTextSizeValue.textContent = `${scale}%`;

        const themeMode = localStorage.getItem(THEME_KEY) || "system";
        updateThemeSegmentUI(themeMode);
      }

      function openModal() {
        syncSettingsUI();
        settingsOverlay.style.display = "flex";
      }
      function closeModal() { settingsOverlay.style.display = "none"; }

      settingsButton.onclick = () => openModal();
      settingsCloseButton.onclick = () => closeModal();
      settingsOverlay.addEventListener("click", (e) => {
        if (e.target === settingsOverlay) closeModal();
      });

      document.querySelectorAll("#themeSegment button").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          localStorage.setItem(THEME_KEY, mode);
          applyTheme(mode);
        });
      });

      refreshLogosBtn.onclick = refreshServiceLogos;

      testBackendBtn.onclick = async () => {
        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
      };

      // Slider behavior (matches picker pattern: live label on input, apply on change)
      btnTextSizeSlider.addEventListener("input", () => {
        btnTextSizeValue.textContent = `${btnTextSizeSlider.value}%`;
      });
      btnTextSizeSlider.addEventListener("change", () => {
        setBtnTextScale(btnTextSizeSlider.value);
        applyBtnTextScale(btnTextSizeSlider.value);
      });

      async function init() {
        loadTheme();
        updateThemeSegmentUI(localStorage.getItem(THEME_KEY) || "system");

        // Apply saved button scale immediately
        applyBtnTextScale(getBtnTextScale());

        setButtonsEnabled(false);
        setBackendStatus(false, "Backend: Checking…");
        setLastAction("—");

        // Startup: attempt backend + logo list
        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
        else {
          fillSelect(serviceLogoSelect, [], SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, [], TESTIMONIES_LOGO_UUID_KEY, true);
          syncDescriptions();
        }

        // Light polling: every 10s
        setInterval(testBackend, 10000);
      }

      init();
    })();
  </script>
</body>
</html>