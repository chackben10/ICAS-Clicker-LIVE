<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ICAS Media Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <style>
    :root {
      --bg: #ffffff;
      --title-color: #d32f2f;
      --status-grey: #666666;

      --card-bg: #f3f3f3;
      --card-text: #111111;
      --border-color: #d0d0d0;

      --btn-bg: #ffffff;
      --btn-text: #111111;
      --btn-border: #d0d0d0;
      --btn-hover: rgba(128,128,128,0.12);

      --modal-bg: #ffffff;
      --modal-shadow: rgba(0,0,0,0.25);
      --settings-text: #111;

      --danger: #ff5252;
      --ok: #00c853;

      /* Button scaling (applies ONLY inside preset buttons) */
      --btn-scale: 1; /* 1 == 100% */
      --grid-gap-base: 10px; /* scaled with --btn-scale */
    }

    body.dark {
      --bg: #000000;
      --title-color: #ff5252;
      --status-grey: #888888;

      --card-bg: #121212;
      --card-text: #ffffff;
      --border-color: #444444;

      --btn-bg: #111111;
      --btn-text: #ffffff;
      --btn-border: #444444;
      --btn-hover: rgba(255,255,255,0.08);

      --modal-bg: #111111;
      --modal-shadow: rgba(0,0,0,0.6);
      --settings-text: #ffffff;

      --danger: #ff5252;
      --ok: #00c853;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; }

    body {
      background: var(--bg);
      color: var(--card-text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 12px;

      transition: background 0.25s ease, color 0.25s ease;
      -webkit-overflow-scrolling: touch;
      touch-action: manipulation;
    }

    .wrapper { width: 100%; max-width: 680px; padding: 16px; }

    /* Top bar */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 12px;
    }

    .page-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--status-grey);
    }

    .top-btn {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--btn-text);
      opacity: 0.9;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .top-btn:hover { opacity: 1; background: var(--btn-hover); }

    .panel-title {
      color: var(--title-color);
      font-size: 1.45rem;
      font-weight: 800;
      margin: 6px 0 8px;
      line-height: 1.1;
    }

    .desc {
      color: var(--status-grey);
      font-size: 0.98rem;
      line-height: 1.35;
      margin-bottom: 12px;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: calc(var(--grid-gap-base) * var(--btn-scale));
      margin-top: 12px;
      align-items: stretch; /* ensure cards stretch to row height */
    }

    @media (min-width: 700px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }

    /* ===== Preset item as a "card" (main action + optional attached sub-action) ===== */
    .preset-card {
      width: 100%;
      display: flex;
      flex-direction: column;
      height: 100%; /* allow grid row to define height */
    }

    .preset-main,
    .preset-addon {
      width: 100%;
      text-align: left;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      position: relative;

      touch-action: pan-y;
      user-select: none;
      -webkit-user-select: none;

      transition: transform 0.07s ease, filter 0.07s ease, background 0.15s ease;
    }

    .preset-main {
      padding: calc(14px * var(--btn-scale)) calc(14px * var(--btn-scale));
      border-radius: clamp(8px, calc(12px * var(--btn-scale)), 16px);

      /* key for equal-height rows: main part expands to fill */
      flex: 1 1 auto;

      /* keep content top-aligned even when stretched taller */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    /* Attached (no gap) addon button */
    .preset-card.has-addon .preset-main {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom-width: 0;
    }

    .preset-addon {
      flex: 0 0 auto;
      padding: calc(14px * var(--btn-scale)) calc(14px * var(--btn-scale));
      border-radius: clamp(8px, calc(12px * var(--btn-scale)), 16px);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      text-align: center;
      font-size: calc(1.05rem * var(--btn-scale));
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .preset-main:hover,
    .preset-addon:hover { background: var(--btn-hover); }

    .preset-main:active,
    .preset-addon:active { transform: scale(0.99); filter: brightness(0.98); }

    .preset-main:disabled,
    .preset-addon:disabled { opacity: 0.55; cursor: not-allowed; }

    .preset-title {
      font-size: calc(1.15rem * var(--btn-scale));
      font-weight: 900;
      letter-spacing: 0.2px;
      margin-bottom: calc(6px * var(--btn-scale));
      line-height: 1.15;
    }

    .preset-sub {
      color: var(--status-grey);
      font-size: calc(0.95rem * var(--btn-scale));
      line-height: 1.25;
    }

    .selector-row {
      margin-top: calc(10px * var(--btn-scale));
      display: flex;
      gap: calc(10px * var(--btn-scale));
      align-items: center;
    }

    .select-wrap { position: relative; width: 100%; }
    .select-wrap::after {
      content: "▾";
      position: absolute;
      right: calc(14px * var(--btn-scale));
      top: 50%;
      transform: translateY(-50%);
      color: var(--card-text);
      opacity: 0.8;
      pointer-events: none;
      font-weight: 900;
      font-size: calc(1rem * var(--btn-scale));
    }

    .select {
      width: 100%;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--card-text);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      font-weight: 800;

      border-radius: clamp(8px, calc(11px * var(--btn-scale)), 14px);
      font-size: calc(16px * var(--btn-scale));
      padding:
        calc(12px * var(--btn-scale))
        calc(40px * var(--btn-scale))
        calc(12px * var(--btn-scale))
        calc(12px * var(--btn-scale));

      touch-action: pan-y;
    }

    /* Red filled button style */
    .danger-fill {
      background: var(--danger);
      color: #ffffff;
      border-color: color-mix(in srgb, var(--danger) 70%, var(--btn-border));
    }
    .danger-fill .preset-sub { color: rgba(255,255,255,0.92); }
    .danger-fill:hover { filter: brightness(0.98); background: var(--danger); }
    .danger-fill:active { filter: brightness(0.96); }

    /* Red filled addon button */
    .preset-addon.danger-fill {
      background: var(--danger);
      color: #ffffff;
      border-color: color-mix(in srgb, var(--danger) 70%, var(--btn-border));
    }
    .preset-addon.danger-fill:hover { filter: brightness(0.98); background: var(--danger); }

    /* Settings modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 18px;
    }

    .settings-card {
      width: 100%;
      max-width: 420px;
      background: var(--modal-bg);
      color: var(--settings-text);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 18px 40px var(--modal-shadow);
      border: 1px solid var(--border-color);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .settings-title {
      font-size: 1.1rem;
      font-weight: 900;
      margin-bottom: 12px;
    }

    .settings-section {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      background: transparent;
    }

    .settings-label {
      font-weight: 900;
      margin-bottom: 6px;
    }

    .settings-muted {
      color: var(--status-grey);
      font-size: 0.92rem;
      line-height: 1.35;
    }

    .pill-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--status-grey);
      font-size: 0.92rem;
      background: transparent;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok { background: var(--ok); }

    .status-text {
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      color: var(--settings-text);
    }

    .mini-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .mini-btn {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--settings-text);
      font-weight: 900;
      font-size: 0.92rem;
      padding: 10px 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .mini-btn:hover { background: rgba(128,128,128,0.12); }
    .mini-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .segment {
      display: flex;
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    .segment button {
      flex: 1;
      padding: 8px 0;
      background: transparent;
      border: none;
      color: var(--settings-text);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.15s;
      -webkit-tap-highlight-color: transparent;
      font-weight: 900;
      touch-action: manipulation;
    }

    .segment button:hover { background: rgba(128,128,128,0.12); }
    .segment button.active {
      background: #ff5252;
      color: white;
      font-weight: 900;
    }

    .settings-close-btn {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: transparent;
      color: var(--settings-text);
      font-size: 0.95rem;
      padding: 10px 0;
      margin-top: 14px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-weight: 900;
      touch-action: manipulation;
    }
    .settings-close-btn:hover { background: rgba(128,128,128,0.12); }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="top-row">
      <div class="page-title">ICAS Media Control Panel</div>
      <button class="top-btn" id="settingsButton">Settings</button>
    </div>

    <div class="panel-title">Presets</div>
    <div class="desc">
      These buttons are presets that trigger multiple actions at once (ProPresenter + OBS).
      You can still control ProPresenter and OBS manually on their own screens anytime.
    </div>

    <div class="grid">
      <!-- Stream Beginning -->
      <div class="preset-card" id="cardStreamBeginning">
        <button class="preset-main" id="btnStreamBeginning" type="button">
          <div class="preset-title">Stream Beginning</div>
          <div class="preset-sub">
            Sets ProPresenter to <b>Starting Announcements</b> and sets OBS scene to <b>Stream Start</b>.
          </div>
        </button>
      </div>

      <!-- Camera + attached Safely Clear -->
      <div class="preset-card has-addon" id="cardCamera">
        <button class="preset-main" id="btnCamera" type="button">
          <div class="preset-title">Camera</div>
          <div class="preset-sub">
            Sets ProPresenter to <b>PTZ Camera</b> and sets OBS scene to <b>PTZ Camera</b>.
          </div>
        </button>
        <button class="preset-addon danger-fill" id="btnCameraSafeClear" type="button">+ Safely Clear Slide</button>
      </div>

      <!-- Service Logo + selector + attached Safely Clear -->
      <div class="preset-card has-addon" id="cardServiceLogo">
        <button class="preset-main" id="btnServiceLogo" type="button">
          <div class="preset-title">Service Logo</div>
          <div class="preset-sub" id="serviceLogoDesc">
            Sets ProPresenter Announcement to <b>—</b>, and shows the <b>Audience Camera</b> on OBS.
          </div>

          <div class="selector-row" aria-label="Service Logo selector">
            <div class="select-wrap" style="flex: 1;">
              <select id="serviceLogoSelect" class="select" title="Default Service Logo"></select>
            </div>
          </div>
        </button>
        <button class="preset-addon danger-fill" id="btnServiceLogoSafeClear" type="button">+ Safely Clear Slide</button>
      </div>

      <!-- Show Slides -->
      <div class="preset-card" id="cardShowSlides">
        <button class="preset-main" id="btnShowSlides" type="button">
          <div class="preset-title">Show Slides</div>
          <div class="preset-sub">
            Clears ProPresenter Announcements and sets OBS scene to <b>ProPresenter Input</b>.
          </div>
        </button>
      </div>

      <!-- Testimonies -->
      <div class="preset-card" id="cardTestimonies">
        <button class="preset-main" id="btnTestimonies" type="button">
          <div class="preset-title">Testimonies</div>
          <div class="preset-sub" id="testimoniesDesc">
            Sets ProPresenter Announcement to <b>—</b> and sets OBS scene to <b>Testimonies</b>.
          </div>

          <div class="selector-row" aria-label="Testimonies selector">
            <div class="select-wrap" style="flex: 1;">
              <select id="testimoniesLogoSelect" class="select" title="Testimonies Service Logo"></select>
            </div>
          </div>
        </button>
      </div>

      <!-- Ending Stream -->
      <div class="preset-card" id="cardEndingStream">
        <button class="preset-main" id="btnEndingStream" type="button">
          <div class="preset-title">Ending Stream</div>
          <div class="preset-sub">
            Sets ProPresenter to <b>Ending Announcements</b> and sets OBS scene to <b>Thanks Screen</b>.
          </div>
        </button>
      </div>

      <!-- Standalone Safely Clear Slide (RED background) -->
      <div class="preset-card" id="cardSafelyClearSlide">
        <button class="preset-main danger-fill" id="btnSafelyClearSlide" type="button">
          <div class="preset-title">Safely Clear Slide</div>
          <div class="preset-sub">
            Clear the presentation in ProPresenter without affecting the camera feeds of the OBS Stream.
          </div>
        </button>
      </div>

      <!-- NSC setup -->
      <div class="preset-card" id="cardNSCSetup">
        <button class="preset-main" id="btnNSCSetup" type="button">
          <div class="preset-title">NSC setup</div>
          <div class="preset-sub">
            Setup ProPresenter to display iMac screen on all in-house tvs.
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsOverlay" class="settings-overlay">
    <div class="settings-card">
      <div class="settings-title">Settings</div>

      <div class="settings-section">
        <div class="settings-label">Backend Status</div>
        <div class="pill-row" aria-live="polite">
          <span class="pill" title="Cloudflare Tunnel backend status">
            <span id="backendDot" class="status-dot"></span>
            <span class="status-text" id="backendStatus">Backend: Checking…</span>
          </span>
          <span class="pill" title="Most recent action run from this page">
            <span class="status-text" id="lastAction">Last action: —</span>
          </span>
        </div>

        <div class="mini-row">
          <button class="mini-btn" id="refreshLogosBtn" type="button">Refresh List</button>
          <button class="mini-btn" id="testBackendBtn" type="button">Test Backend</button>
        </div>

        <div class="settings-muted" style="margin-top: 10px;">
          Backend should be: <b>https://control.icas-clicker.work</b>
        </div>
      </div>

      <!-- Button scale slider (no extra text / no % label) -->
      <div class="settings-section">
        <input type="range" id="btnTextSizeSlider" min="40" max="200" step="10" style="width:100%;">
      </div>

      <div class="settings-section">
        <div class="settings-label">Display Theme</div>
        <div class="segment" id="themeSegment">
          <button data-mode="light">Light</button>
          <button data-mode="dark">Dark</button>
          <button data-mode="system">System</button>
        </div>
      </div>

      <button id="settingsCloseButton" class="settings-close-btn">Close</button>
    </div>
  </div>

  <script>
    (function () {
      // ====== CONFIG ======
      const DEFAULT_API_BASE = "https://control.icas-clicker.work";

      const THEME_KEY = "icas-theme-mode";

      // Persisted selections
      const SERVICE_LOGO_UUID_KEY = "icas-service-logo-uuid";
      const TESTIMONIES_LOGO_UUID_KEY = "icas-testimonies-logo-uuid";

      // Button scaling (40–200)
      const BTN_SCALE_KEY = "icas-control-btn-scale";

      function normalizeBase(u) {
        u = String(u || "").trim();
        return (u || DEFAULT_API_BASE).replace(/\/+$/, "");
      }

      function getApiBase() {
        return normalizeBase(DEFAULT_API_BASE);
      }

      function endpoints() {
        const base = getApiBase();
        return {
          health: `${base}/health`,
          serviceLogos: `${base}/service_logos`,
          preset: `${base}/preset`
        };
      }

      // ====== THEME ======
      function applyTheme(mode) {
        if (mode === "light") document.body.classList.remove("dark");
        else if (mode === "dark") document.body.classList.add("dark");
        else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) document.body.classList.add("dark");
          else document.body.classList.remove("dark");
        }
        updateThemeSegmentUI(mode);
      }

      function updateThemeSegmentUI(mode) {
        document.querySelectorAll("#themeSegment button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.mode === mode);
        });
      }

      function loadTheme() {
        const stored = localStorage.getItem(THEME_KEY);
        applyTheme(stored || "system");
      }

      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        const stored = localStorage.getItem(THEME_KEY) || "system";
        if (stored === "system") applyTheme("system");
      });

      // ====== Button scale (only inside preset buttons) ======
      function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }

      function getBtnScalePercent() {
        const raw = parseInt(localStorage.getItem(BTN_SCALE_KEY), 10);
        if (Number.isNaN(raw)) return 100;
        return clamp(raw, 40, 200);
      }

      function setBtnScalePercent(v) {
        const n = clamp(parseInt(v, 10) || 100, 40, 200);
        localStorage.setItem(BTN_SCALE_KEY, String(n));
        applyBtnScale(n);
      }

      function applyBtnScale(percent) {
        const s = clamp((percent || 100) / 100, 0.4, 2.0);
        document.documentElement.style.setProperty("--btn-scale", String(s));
      }

      // ====== UI refs ======
      const backendDot = document.getElementById("backendDot");
      const backendStatus = document.getElementById("backendStatus");
      const lastAction = document.getElementById("lastAction");

      const refreshLogosBtn = document.getElementById("refreshLogosBtn");
      const testBackendBtn = document.getElementById("testBackendBtn");

      const serviceLogoSelect = document.getElementById("serviceLogoSelect");
      const testimoniesLogoSelect = document.getElementById("testimoniesLogoSelect");

      const serviceLogoDesc = document.getElementById("serviceLogoDesc");
      const testimoniesDesc = document.getElementById("testimoniesDesc");

      // Buttons
      const btnStreamBeginning = document.getElementById("btnStreamBeginning");
      const btnCamera = document.getElementById("btnCamera");
      const btnServiceLogo = document.getElementById("btnServiceLogo");
      const btnShowSlides = document.getElementById("btnShowSlides");
      const btnTestimonies = document.getElementById("btnTestimonies");
      const btnEndingStream = document.getElementById("btnEndingStream");

      const btnCameraSafeClear = document.getElementById("btnCameraSafeClear");
      const btnServiceLogoSafeClear = document.getElementById("btnServiceLogoSafeClear");

      const btnSafelyClearSlide = document.getElementById("btnSafelyClearSlide");
      const btnNSCSetup = document.getElementById("btnNSCSetup");

      // Slider UI (no label)
      const btnTextSizeSlider = document.getElementById("btnTextSizeSlider");

      // Prevent select taps from triggering the main button (and allow scrolling)
      function stopBtnClickWhenSelecting(selectEl) {
        ["click","pointerdown","touchstart","mousedown"].forEach(evt => {
          selectEl.addEventListener(evt, (e) => e.stopPropagation(), { passive: true });
        });
      }
      stopBtnClickWhenSelecting(serviceLogoSelect);
      stopBtnClickWhenSelecting(testimoniesLogoSelect);

      function setBackendStatus(ok, text) {
        backendDot.classList.toggle("ok", !!ok);
        backendStatus.textContent = text || (ok ? "Backend: Connected" : "Backend: Offline");
      }

      function setLastAction(text) {
        lastAction.textContent = `Last action: ${text || "—"}`;
      }

      function setButtonsEnabled(enabled) {
        [
          btnStreamBeginning, btnCamera, btnServiceLogo, btnShowSlides,
          btnTestimonies, btnEndingStream,
          btnCameraSafeClear, btnServiceLogoSafeClear,
          btnSafelyClearSlide, btnNSCSetup
        ].forEach(b => { if (b) b.disabled = !enabled; });

        refreshLogosBtn.disabled = !enabled;
        testBackendBtn.disabled = false; // always allow manual test attempt
        serviceLogoSelect.disabled = !enabled;
        testimoniesLogoSelect.disabled = !enabled;
      }

      function escapeHtml(s) {
        return String(s || "").replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[c]));
      }

      function getStored(key) { return (localStorage.getItem(key) || "").trim(); }
      function setStored(key, val) { localStorage.setItem(key, String(val || "").trim()); }

      function selectedName(selectEl) {
        const opt = selectEl.options[selectEl.selectedIndex];
        return opt ? (opt.textContent || "—") : "—";
      }

      function syncDescriptions() {
        const sName = selectedName(serviceLogoSelect);
        const tName = selectedName(testimoniesLogoSelect);

        serviceLogoDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(sName)}</b>, and shows the <b>Audience Camera</b> on OBS.`;
        testimoniesDesc.innerHTML =
          `Sets ProPresenter Announcement to <b>${escapeHtml(tName)}</b> and sets OBS scene to <b>Testimonies</b>.`;
      }

      async function testBackend() {
        const { health } = endpoints();
        try {
          const res = await fetch(health, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          setBackendStatus(true, "Backend: Connected ✔");
          setButtonsEnabled(true);
          return true;
        } catch {
          setBackendStatus(false, "Backend: Offline");
          setButtonsEnabled(false);
          return false;
        }
      }

      function fillSelect(selectEl, items, storageKey, preferBasic) {
        const prev = getStored(storageKey);
        selectEl.innerHTML = "";

        if (!Array.isArray(items) || items.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No service logos found";
          selectEl.appendChild(opt);
          selectEl.value = "";
          return;
        }

        items.forEach(it => {
          const opt = document.createElement("option");
          opt.value = String(it.uuid || "");
          opt.textContent = String(it.name || "(Unnamed)");
          selectEl.appendChild(opt);
        });

        if (prev && items.some(x => String(x.uuid) === prev)) {
          selectEl.value = prev;
        } else if (preferBasic) {
          const basic = items.find(x => String(x.name) === "Basic Service Logo");
          if (basic) selectEl.value = String(basic.uuid || "");
          else selectEl.value = String(items[0].uuid || "");
          setStored(storageKey, selectEl.value);
        } else {
          selectEl.value = String(items[0].uuid || "");
          setStored(storageKey, selectEl.value);
        }
      }

      async function refreshServiceLogos() {
        const { serviceLogos } = endpoints();
        try {
          const res = await fetch(serviceLogos, { cache: "no-cache" });
          if (!res.ok) throw new Error("Bad response");
          const data = await res.json();
          const items = Array.isArray(data?.items) ? data.items : [];

          fillSelect(serviceLogoSelect, items, SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, items, TESTIMONIES_LOGO_UUID_KEY, true);

          if (!getStored(SERVICE_LOGO_UUID_KEY)) setStored(SERVICE_LOGO_UUID_KEY, serviceLogoSelect.value);
          if (!getStored(TESTIMONIES_LOGO_UUID_KEY)) setStored(TESTIMONIES_LOGO_UUID_KEY, testimoniesLogoSelect.value);

          syncDescriptions();
        } catch {
          fillSelect(serviceLogoSelect, [], SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, [], TESTIMONIES_LOGO_UUID_KEY, true);
          syncDescriptions();
        }
      }

      serviceLogoSelect.addEventListener("change", () => {
        setStored(SERVICE_LOGO_UUID_KEY, serviceLogoSelect.value);
        syncDescriptions();
      });

      testimoniesLogoSelect.addEventListener("change", () => {
        setStored(TESTIMONIES_LOGO_UUID_KEY, testimoniesLogoSelect.value);
        syncDescriptions();
      });

      // ====== Fix accidental presses during scroll (touch devices) ======
      // Fire only on "tap" (small movement). Prevent delayed click from scroll.
      function attachTapHandler(el, handler) {
        if (!el) return;

        let startX = 0, startY = 0, moved = false, activePointerId = null;
        const MOVE_PX = 10;

        el.addEventListener("pointerdown", (e) => {
          if (el.disabled) return;
          if (e.isPrimary === false) return;
          activePointerId = e.pointerId;
          moved = false;
          startX = e.clientX;
          startY = e.clientY;
          try { el.setPointerCapture(e.pointerId); } catch {}
        });

        el.addEventListener("pointermove", (e) => {
          if (activePointerId === null || e.pointerId !== activePointerId) return;
          const dx = Math.abs(e.clientX - startX);
          const dy = Math.abs(e.clientY - startY);
          if (dx > MOVE_PX || dy > MOVE_PX) moved = true;
        });

        function finish(e) {
          if (activePointerId === null || e.pointerId !== activePointerId) return;
          try { el.releasePointerCapture(e.pointerId); } catch {}
          const shouldFire = !moved;
          activePointerId = null;
          if (shouldFire) handler();
        }

        el.addEventListener("pointerup", finish);
        el.addEventListener("pointercancel", () => { activePointerId = null; moved = false; });

        // Block native click (prevents "scroll then click" behavior)
        el.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, true);
      }

      async function runPreset(presetName) {
        const ok = await testBackend();
        if (!ok) { setLastAction("Failed (backend offline)"); return; }

        const { preset } = endpoints();
        const payload = { preset: presetName };

        if (presetName === "service_logo") {
          const uuid = getStored(SERVICE_LOGO_UUID_KEY) || serviceLogoSelect.value;
          if (!uuid) { setLastAction("Failed (no Service Logo selected)"); return; }
          payload.service_logo_uuid = uuid;
        }

        if (presetName === "testimonies") {
          const uuid = getStored(TESTIMONIES_LOGO_UUID_KEY) || testimoniesLogoSelect.value;
          if (!uuid) { setLastAction("Failed (no Testimonies logo selected)"); return; }
          payload.service_logo_uuid = uuid; // backend expects service_logo_uuid
        }

        setLastAction(`Running: ${presetName}`);

        try {
          const res = await fetch(preset, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Bad response");
          setLastAction(`Done: ${presetName}`);
        } catch {
          setLastAction(`Failed: ${presetName}`);
        }
      }

      // Helper to run preset with ?safeclear=true query param
      async function runPresetSafeClear(presetName) {
        const ok = await testBackend();
        if (!ok) { setLastAction("Failed (backend offline)"); return; }

        const { preset } = endpoints();
        const url = `${preset}?safeclear=true`;
        const payload = { preset: presetName };

        if (presetName === "service_logo") {
          const uuid = getStored(SERVICE_LOGO_UUID_KEY) || serviceLogoSelect.value;
          if (!uuid) { setLastAction("Failed (no Service Logo selected)"); return; }
          payload.service_logo_uuid = uuid;
        }

        setLastAction(`Running: ${presetName} (safeclear)`);

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("Bad response");
          setLastAction(`Done: ${presetName} (safeclear)`);
        } catch {
          setLastAction(`Failed: ${presetName} (safeclear)`);
        }
      }

      // Wire buttons via tap handler
      attachTapHandler(btnStreamBeginning, () => runPreset("stream_beginning"));
      attachTapHandler(btnCamera, () => runPreset("camera"));
      attachTapHandler(btnServiceLogo, () => runPreset("service_logo"));
      attachTapHandler(btnShowSlides, () => runPreset("show_slides"));
      attachTapHandler(btnTestimonies, () => runPreset("testimonies"));
      attachTapHandler(btnEndingStream, () => runPreset("ending_stream"));

      // Attached sub-actions (same endpoint + ?safeclear=true)
      attachTapHandler(btnCameraSafeClear, () => runPresetSafeClear("camera"));
      attachTapHandler(btnServiceLogoSafeClear, () => runPresetSafeClear("service_logo"));

      // Standalone buttons (stubs we will implement later in init.lua)
      attachTapHandler(btnSafelyClearSlide, () => runPreset("safely_clear_slide"));
      attachTapHandler(btnNSCSetup, () => runPreset("nsc_setup"));

      // Settings modal
      const settingsOverlay = document.getElementById("settingsOverlay");
      const settingsButton = document.getElementById("settingsButton");
      const settingsCloseButton = document.getElementById("settingsCloseButton");

      function openModal() { settingsOverlay.style.display = "flex"; }
      function closeModal() { settingsOverlay.style.display = "none"; }

      settingsButton.onclick = () => openModal();
      settingsCloseButton.onclick = () => closeModal();
      settingsOverlay.addEventListener("click", (e) => {
        if (e.target === settingsOverlay) closeModal();
      });

      document.querySelectorAll("#themeSegment button").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          localStorage.setItem(THEME_KEY, mode);
          applyTheme(mode);
        });
      });

      refreshLogosBtn.onclick = refreshServiceLogos;

      testBackendBtn.onclick = async () => {
        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
      };

      // Slider behavior (no visible % label)
      function syncBtnSliderUI() {
        const pct = getBtnScalePercent();
        btnTextSizeSlider.value = pct;
        applyBtnScale(pct);
      }

      btnTextSizeSlider.addEventListener("input", () => {
        applyBtnScale(parseInt(btnTextSizeSlider.value, 10));
      });

      btnTextSizeSlider.addEventListener("change", () => {
        setBtnScalePercent(btnTextSizeSlider.value);
      });

      async function init() {
        loadTheme();
        updateThemeSegmentUI(localStorage.getItem(THEME_KEY) || "system");

        // apply stored button scale immediately
        syncBtnSliderUI();

        setButtonsEnabled(false);
        setBackendStatus(false, "Backend: Checking…");
        setLastAction("—");

        // Startup: attempt backend + logo list
        const ok = await testBackend();
        if (ok) await refreshServiceLogos();
        else {
          fillSelect(serviceLogoSelect, [], SERVICE_LOGO_UUID_KEY, true);
          fillSelect(testimoniesLogoSelect, [], TESTIMONIES_LOGO_UUID_KEY, true);
          syncDescriptions();
        }

        // Light polling: every 10s
        setInterval(testBackend, 10000);
      }

      init();
    })();
  </script>
</body>
</html>