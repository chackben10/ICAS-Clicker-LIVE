<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Slide Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --btn-prev-bg: #ffffff;
      --btn-prev-text: #000000;
      --btn-next-bg: #00c853;
      --btn-next-text: #ffffff;
      --title-color: #ff5252;
      --status-grey: #888888;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 12px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .presentation-name {
      text-align: left;
      color: var(--title-color);
      font-size: 1.4rem;
      font-weight: 700;
      min-height: 1.4em;
      margin-right: 8px;
    }

    .nav-link {
      font-size: 0.9rem;
      color: #ffffff;
      opacity: 0.8;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      white-space: nowrap;
    }

    .nav-link:hover {
      opacity: 1;
      background: #222;
    }

    .slide-box {
      margin: 0 auto 8px;
      background: #ffffff;
      color: #000000;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;

      aspect-ratio: 16 / 9;
      width: min(100%, calc(100vh / 3 * 16 / 9));
      position: relative;
    }

    .slide-text {
      text-align: center;
      white-space: normal;
      word-break: break-word;
      width: 100%;
      margin: 0;
    }

    .slide-status {
      text-align: center;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: var(--status-grey);
    }

    .slide-status .current { color: #ffffff; font-weight: 600; }
    .slide-status .total   { color: var(--status-grey); }

    .buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 16px 12px;
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.07s ease, filter 0.07s ease;
      width: 100%;
    }

    button:active { transform: scale(0.97); filter: brightness(0.9); }
    .btn-prev { background: var(--btn-prev-bg); color: var(--btn-prev-text); }
    .btn-next { background: var(--btn-next-bg); color: var(--btn-next-text); }

    .status {
      text-align: center;
      margin-top: 16px;
      font-size: 0.9rem;
      opacity: 0.8;
      min-height: 1.1em;
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <div class="top-row">
      <div id="presentationName" class="presentation-name">Loading presentation...</div>
      <a href="picker.html" class="nav-link">Picker</a>
    </div>

    <div id="slideBox" class="slide-box">
      <p id="slideText" class="slide-text"></p>
      <img id="slideImage" style="display:none; max-width:100%; max-height:100%; object-fit:contain;" />
    </div>

    <div class="slide-status">
      Slide <span id="slideCurrent" class="current">0</span> of
      <span id="slideTotal" class="total">0</span>
    </div>

    <div class="buttons">
      <button class="btn-prev" onclick="sendCommand('previous')">Previous</button>
      <button class="btn-next" onclick="sendCommand('next')">Next</button>
    </div>

    <div class="status" id="statusText">Ready</div>
  </div>

  <script>
    const BASE_URL = 'https://slides.icas-clicker.work';

    async function sendCommand(action) {
      const statusEl = document.getElementById('statusText');
      statusEl.textContent = action === 'next' ? 'Sending: Next…' : 'Sending: Previous…';

      try {
        const endpoint = action === 'next' ? '/next' : '/previous';
        const res = await fetch(`${BASE_URL}${endpoint}`, { method: 'GET', cache: 'no-cache' });
        if (!res.ok) throw new Error("Bad response");
        statusEl.textContent = "Command sent ✔";
        refreshStatus();
      } catch (err) {
        statusEl.textContent = "Error sending command";
      }

      setTimeout(() => { statusEl.textContent = "Ready"; }, 1000);
    }

    function fitSlideText() {
      const box = document.getElementById('slideBox');
      const textEl = document.getElementById('slideText');
      if (!box || !textEl) return;

      let fontSize = 40;
      textEl.style.fontSize = fontSize + "px";

      const boxHeight = box.clientHeight - 16;
      const boxWidth = box.clientWidth - 16;

      while (fontSize > 14 && (textEl.scrollHeight > boxHeight || textEl.scrollWidth > boxWidth)) {
        fontSize -= 1;
        textEl.style.fontSize = fontSize + "px";
      }
    }

    async function loadThumbnail(uuid, index) {
      try {
        const res = await fetch(
          `${BASE_URL}/thumbnail?uuid=${uuid}&index=${index}&t=${Date.now()}`,
          { method: "GET", cache: "no-cache" }
        );

        if (!res.ok) throw new Error("Bad thumbnail response");

        const blob = await res.blob();
        return URL.createObjectURL(blob);

      } catch (err) {
        console.error("Thumbnail error", err);
        return null;
      }
    }

    async function refreshStatus() {
      const nameEl = document.getElementById('presentationName');
      const slideTextEl = document.getElementById('slideText');
      const slideImageEl = document.getElementById('slideImage');
      const slideCurrentEl = document.getElementById('slideCurrent');
      const slideTotalEl = document.getElementById('slideTotal');

      try {
        const [presRes, indexRes] = await Promise.all([
          fetch(`${BASE_URL}/active-presentation`, { cache: "no-cache" }),
          fetch(`${BASE_URL}/slide-index`, { cache: "no-cache" })
        ]);

        const presData = await presRes.json();
        const idxData = await indexRes.json();

        // Presentation name
        nameEl.textContent = presData?.presentation?.id?.name || "No active presentation";

        // Slides
        let slides = [];
        presData.presentation?.groups?.forEach(group => {
          if (Array.isArray(group.slides)) slides = slides.concat(group.slides);
        });

        const totalSlides = slides.length;
        const slideIndex = idxData?.presentation_index?.index ?? 0;

        const currentSlide = slides[slideIndex];
        const currentText = (currentSlide?.text || "").trim();

        // Case 1: Slide has text
        if (currentText !== "") {
          slideImageEl.style.display = "none";
          slideTextEl.style.display = "block";

          const htmlText = currentText
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n')
            .split('\n')
            .map(l => l.trimEnd())
            .join('<br>');

          slideTextEl.innerHTML = htmlText;
          fitSlideText();
        }
        // Case 2: Slide has NO text → load PNG thumbnail
        else {
          const uuid = presData?.presentation?.id?.uuid;
          if (uuid) {
            const imgURL = await loadThumbnail(uuid, slideIndex);

            if (imgURL) {
              slideTextEl.style.display = "none";
              slideImageEl.style.display = "block";
              slideImageEl.src = imgURL;
            } else {
              slideImageEl.style.display = "none";
              slideTextEl.style.display = "block";
              slideTextEl.textContent = "(No Text / No Thumbnail)";
            }
          }
        }

        slideCurrentEl.textContent = totalSlides > 0 ? slideIndex + 1 : 0;
        slideTotalEl.textContent = totalSlides;

      } catch (err) {
        console.error(err);
        nameEl.textContent = "No active presentation";
        slideTextEl.textContent = "";
        slideCurrentEl.textContent = "0";
        slideTotalEl.textContent = "0";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      refreshStatus();
      setInterval(refreshStatus, 1000);
      window.addEventListener("resize", fitSlideText);
    });
  </script>
</body>
</html>
