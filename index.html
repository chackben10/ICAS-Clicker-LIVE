<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Slide Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --btn-prev-bg: #ffffff;
      --btn-prev-text: #000000;
      --btn-next-bg: #00c853;
      --btn-next-text: #ffffff;
      --title-color: #ff5252;
      --page-title-color: #bbbbbb;
      --status-grey: #888888;
      --overlay-bg: rgba(0, 0, 0, 0.7);
      --card-bg: #111111;
      --card-border: #333333;
      --accent: #00c853;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 12px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    /* Top bar: page title + actions */
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .page-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--page-title-color);
    }

    .top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-link {
      font-size: 0.9rem;
      color: #ffffff;
      opacity: 0.8;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      white-space: nowrap;
      background: transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      appearance: none;
    }

    .nav-link:hover {
      opacity: 1;
      background: #222;
    }

    /* Presentation title now under buttons */
    .presentation-name {
      text-align: left;
      color: var(--title-color);
      font-size: 1.4rem;
      font-weight: 700;
      min-height: 1.4em;
      margin: 4px 0 10px 0;
    }

    .slide-box {
      margin: 0 auto 8px;
      background: #ffffff;
      color: #000000;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;

      aspect-ratio: 16 / 9;
      width: min(100%, calc(100vh / 3 * 16 / 9));
      position: relative;
    }

    .slide-text {
      text-align: center;
      white-space: normal;
      word-break: break-word;
      width: 100%;
      margin: 0;
    }

    .slide-status {
      text-align: center;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: var(--status-grey);
    }

    .slide-status .current { color: #ffffff; font-weight: 600; }
    .slide-status .total   { color: var(--status-grey); }

    .buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 16px 12px;
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.07s ease, filter 0.07s ease;
      width: 100%;
    }

    button:active { transform: scale(0.97); filter: brightness(0.9); }
    .btn-prev { background: var(--btn-prev-bg); color: var(--btn-prev-text); }
    .btn-next { background: var(--btn-next-bg); color: var(--btn-next-text); }

    .status {
      text-align: center;
      margin-top: 16px;
      font-size: 0.9rem;
      opacity: 0.8;
      min-height: 1.1em;
    }

    /* SETTINGS MODAL */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .settings-card {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--card-border);
      padding: 16px 18px 12px 18px;
      width: min(90%, 360px);
      position: relative;
    }

    .settings-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 10px;
      padding-right: 24px; /* space so title doesn't run under the X */
    }

    .settings-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .settings-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #ffffff;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 6px;
      line-height: 1;
    }

    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 0.95rem;
    }

    .settings-label {
      margin-right: 12px;
    }

    .settings-toggle {
      width: 40px;
      height: 22px;
      border-radius: 999px;
      background: #444;
      border: 1px solid #666;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    .settings-toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ccc;
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .settings-toggle-input {
      display: none;
    }

    .settings-toggle-input:checked + .settings-toggle .settings-toggle-knob {
      transform: translateX(16px);
      background: #ffffff;
    }

    .settings-toggle-input:checked + .settings-toggle {
      background: var(--accent);
      border-color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- Top bar: page title + actions -->
    <div class="top-row">
      <div class="page-title">Clicker</div>
      <div class="top-actions">
        <a href="picker.html" class="nav-link">Picker</a>
        <button type="button" class="nav-link" onclick="openSettings()">Settings</button>
      </div>
    </div>

    <!-- Presentation title under buttons -->
    <div id="presentationName" class="presentation-name">Loading presentation...</div>

    <div id="slideBox" class="slide-box">
      <p id="slideText" class="slide-text"></p>
      <img
        id="slideImage"
        style="display:none; max-width:100%; max-height:100%; object-fit:contain; border-radius:8px;"
      />
    </div>

    <div class="slide-status">
      Slide <span id="slideCurrent" class="current">0</span> of
      <span id="slideTotal" class="total">0</span>
    </div>

    <div class="buttons">
      <button class="btn-prev" onclick="sendCommand('previous')">Previous</button>
      <button class="btn-next" onclick="sendCommand('next')">Next</button>
    </div>

    <div class="status" id="statusText">Ready</div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsOverlay" class="settings-overlay">
    <div class="settings-card">
      <div class="settings-header">
        <div class="settings-title">Settings</div>
      </div>
      <button class="settings-close" onclick="closeSettings()">×</button>

      <div class="settings-row">
        <div class="settings-label">Thumbnails only</div>
        <label style="display:flex; align-items:center;">
          <input
            type="checkbox"
            id="thumbsOnlyToggle"
            class="settings-toggle-input"
            onchange="onThumbsToggleChange(this.checked)"
          />
          <div class="settings-toggle">
            <div class="settings-toggle-knob"></div>
          </div>
        </label>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://slides.icas-clicker.work';
    const SETTINGS_KEY = 'slides_thumbnails_only';

    let thumbnailsOnly = false;

    function loadSettings() {
      const stored = localStorage.getItem(SETTINGS_KEY);
      thumbnailsOnly = stored === 'true';
      const toggle = document.getElementById('thumbsOnlyToggle');
      if (toggle) {
        toggle.checked = thumbnailsOnly;
      }
    }

    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, thumbnailsOnly ? 'true' : 'false');
    }

    function openSettings() {
      loadSettings(); // sync UI with current state
      const overlay = document.getElementById('settingsOverlay');
      if (overlay) overlay.style.display = 'flex';
    }

    function closeSettings() {
      const overlay = document.getElementById('settingsOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    function onThumbsToggleChange(checked) {
      thumbnailsOnly = !!checked;
      saveSettings();
      refreshStatus();
    }

    async function sendCommand(action) {
      const statusEl = document.getElementById('statusText');
      statusEl.textContent = action === 'next' ? 'Sending: Next…' : 'Sending: Previous…';

      try {
        const endpoint = action === 'next' ? '/next' : '/previous';
        const res = await fetch(`${BASE_URL}${endpoint}`, { method: 'GET', cache: 'no-cache' });
        if (!res.ok) throw new Error("Bad response");
        statusEl.textContent = "Command sent ✔";
        refreshStatus();
      } catch (err) {
        statusEl.textContent = "Error sending command";
      }

      setTimeout(() => { statusEl.textContent = "Ready"; }, 1000);
    }

    function fitSlideText() {
      const box = document.getElementById('slideBox');
      const textEl = document.getElementById('slideText');
      if (!box || !textEl) return;

      let fontSize = 40;
      textEl.style.fontSize = fontSize + "px";

      const boxHeight = box.clientHeight - 16;
      const boxWidth = box.clientWidth - 16;

      while (fontSize > 14 && (textEl.scrollHeight > boxHeight || textEl.scrollWidth > boxWidth)) {
        fontSize -= 1;
        textEl.style.fontSize = fontSize + "px";
      }
    }

    async function loadThumbnail(uuid, index) {
      try {
        const res = await fetch(
          `${BASE_URL}/thumbnail?uuid=${uuid}&index=${index}&t=${Date.now()}`,
          { method: "GET", cache: "no-cache" }
        );

        if (!res.ok) throw new Error("Bad thumbnail response");

        const blob = await res.blob();
        return URL.createObjectURL(blob);

      } catch (err) {
        console.error("Thumbnail error", err);
        return null;
      }
    }

    async function refreshStatus() {
      const nameEl = document.getElementById('presentationName');
      const slideTextEl = document.getElementById('slideText');
      const slideImageEl = document.getElementById('slideImage');
      const slideCurrentEl = document.getElementById('slideCurrent');
      const slideTotalEl = document.getElementById('slideTotal');

      try {
        const [presRes, indexRes] = await Promise.all([
          fetch(`${BASE_URL}/active-presentation`, { cache: "no-cache" }),
          fetch(`${BASE_URL}/slide-index`, { cache: "no-cache" })
        ]);

        const presData = await presRes.json();
        const idxData = await indexRes.json();

        nameEl.textContent = presData?.presentation?.id?.name || "No active presentation";

        let slides = [];
        presData.presentation?.groups?.forEach(group => {
          if (Array.isArray(group.slides)) slides = slides.concat(group.slides);
        });

        const totalSlides = slides.length;
        const slideIndex = idxData?.presentation_index?.index ?? 0;
        const currentSlide = slides[slideIndex];
        const currentTextRaw = (currentSlide?.text || "");
        const currentText = currentTextRaw.trim();
        const uuid = presData?.presentation?.id?.uuid || null;

        function showText(text) {
          const htmlText = (text || "")
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n')
            .split('\n')
            .map(l => l.trimEnd())
            .join('<br>');

          slideImageEl.style.display = "none";
          slideTextEl.style.display = "block";
          slideTextEl.innerHTML = htmlText;
          fitSlideText();
        }

        function showFallbackMessage() {
          slideImageEl.style.display = "none";
          slideTextEl.style.display = "block";
          slideTextEl.textContent = "(No Text / No Thumbnail)";
        }

        if (!currentSlide) {
          showFallbackMessage();
        } else {
          if (thumbnailsOnly && uuid) {
            const imgURL = await loadThumbnail(uuid, slideIndex);
            if (imgURL) {
              slideTextEl.style.display = "none";
              slideImageEl.style.display = "block";
              slideImageEl.src = imgURL;
            } else if (currentText !== "") {
              showText(currentTextRaw);
            } else {
              showFallbackMessage();
            }
          } else {
            if (currentText !== "") {
              showText(currentTextRaw);
            } else if (uuid) {
              const imgURL = await loadThumbnail(uuid, slideIndex);
              if (imgURL) {
                slideTextEl.style.display = "none";
                slideImageEl.style.display = "block";
                slideImageEl.src = imgURL;
              } else {
                showFallbackMessage();
              }
            } else {
              showFallbackMessage();
            }
          }
        }

        slideCurrentEl.textContent = totalSlides > 0 ? slideIndex + 1 : 0;
        slideTotalEl.textContent = totalSlides;

      } catch (err) {
        console.error(err);
        nameEl.textContent = "No active presentation";
        slideTextEl.textContent = "";
        slideCurrentEl.textContent = "0";
        slideTotalEl.textContent = "0";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadSettings();
      refreshStatus();
      setInterval(refreshStatus, 1000);
      window.addEventListener("resize", fitSlideText);
    });
  </script>
</body>
</html>
